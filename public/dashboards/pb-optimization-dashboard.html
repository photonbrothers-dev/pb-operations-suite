<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="PB Pipeline Optimizer - AI-powered scheduling optimization and bottleneck detection">
<meta name="theme-color" content="#0f172a">
<title>PB Pipeline Optimizer | Photon Brothers</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg: #0f172a;
  --surface: #1e293b;
  --surface-hover: #334155;
  --border: #475569;
  --text: #f1f5f9;
  --text-dim: #94a3b8;
  --primary: #3b82f6;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --purple: #8b5cf6;
  --pe-green: #22c55e;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}
.header {
  background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%);
  padding: 1.5rem 2rem;
  border-bottom: 1px solid var(--border);
}
.header h1 { font-size: 1.75rem; margin-bottom: 0.25rem; }
.header p { color: rgba(255,255,255,0.8); font-size: 0.9rem; }
.header-stats {
  display: flex;
  gap: 2rem;
  margin-top: 1rem;
}
.header-stat {
  text-align: center;
}
.header-stat-value {
  font-size: 1.5rem;
  font-weight: 700;
}
.header-stat-label {
  font-size: 0.75rem;
  opacity: 0.8;
}
.container {
  max-width: 1600px;
  margin: 0 auto;
  padding: 1.5rem;
}
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; }
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.25rem;
}
.card-title {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.bottleneck {
  background: var(--surface);
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.75rem;
  border-left: 4px solid;
}
.bottleneck.high { border-left-color: var(--danger); background: rgba(239, 68, 68, 0.1); }
.bottleneck.medium { border-left-color: var(--warning); background: rgba(245, 158, 11, 0.1); }
.bottleneck-title {
  font-weight: 600;
  margin-bottom: 0.25rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.bottleneck-desc { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.5rem; }
.bottleneck-impact { font-size: 0.8rem; color: var(--warning); margin-bottom: 0.5rem; }
.bottleneck-rec {
  font-size: 0.8rem;
  background: var(--surface-hover);
  padding: 0.5rem;
  border-radius: 4px;
  margin-top: 0.5rem;
}
.badge {
  display: inline-block;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: 600;
}
.badge-high { background: var(--danger); color: white; }
.badge-medium { background: var(--warning); color: black; }
.priority-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem;
  background: var(--surface-hover);
  border-radius: 8px;
  margin-bottom: 0.5rem;
}
.priority-rank {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--primary);
  border-radius: 50%;
  font-weight: 700;
  font-size: 0.85rem;
}
.priority-item:nth-child(1) .priority-rank { background: #fbbf24; color: black; }
.priority-item:nth-child(2) .priority-rank { background: #9ca3af; color: black; }
.priority-item:nth-child(3) .priority-rank { background: #b45309; color: white; }
.priority-info { flex: 1; min-width: 0; }
.priority-name {
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.priority-meta { font-size: 0.75rem; color: var(--text-dim); }
.priority-score {
  text-align: right;
}
.priority-score-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--primary);
}
.priority-score-label {
  font-size: 0.65rem;
  color: var(--text-dim);
}
.pe-badge {
  background: var(--pe-green);
  color: white;
  padding: 0.15rem 0.4rem;
  border-radius: 3px;
  font-size: 0.65rem;
  font-weight: 600;
  margin-left: 0.5rem;
}
.metric-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
}
.metric {
  background: var(--surface-hover);
  padding: 1rem;
  border-radius: 8px;
  text-align: center;
}
.metric-value {
  font-size: 1.75rem;
  font-weight: 700;
}
.metric-label {
  font-size: 0.75rem;
  color: var(--text-dim);
}
.efficiency-bar {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--border);
}
.efficiency-bar:last-child { border-bottom: none; }
.efficiency-loc { width: 140px; font-weight: 500; }
.efficiency-progress {
  flex: 1;
  height: 24px;
  background: var(--surface-hover);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}
.efficiency-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}
.efficiency-score {
  width: 60px;
  text-align: right;
  font-weight: 600;
}
.chart-container {
  height: 200px;
  position: relative;
}
.section-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin: 2rem 0 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
th {
  background: var(--surface-hover);
  font-weight: 600;
  font-size: 0.8rem;
  color: var(--text-dim);
}
td { font-size: 0.85rem; }
tr:hover { background: var(--surface-hover); }
a { color: var(--primary); text-decoration: none; }
a:hover { text-decoration: underline; }
.days-badge {
  display: inline-block;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
}
.days-overdue { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
.days-urgent { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
.days-ok { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
.tab-container {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  border-bottom: 1px solid var(--border);
  padding-bottom: 0.5rem;
}
.tab {
  padding: 0.5rem 1rem;
  background: transparent;
  border: none;
  color: var(--text-dim);
  cursor: pointer;
  font-size: 0.9rem;
  border-radius: 4px;
}
.tab:hover { background: var(--surface-hover); }
.tab.active { background: var(--primary); color: white; }
.stage-chart { height: 300px; }

/* Accessibility */
.priority-item:focus,
.bottleneck:focus,
tr:focus {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

/* Loading state */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Error state */
.error-message {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid var(--danger);
  border-radius: 8px;
  padding: 1rem;
  color: var(--danger);
  margin: 1rem 0;
}

/* Print styles */
@media print {
  body { background: white; color: black; }
  .header { background: #1e40af; -webkit-print-color-adjust: exact; }
  .card { border: 1px solid #ccc; break-inside: avoid; page-break-inside: avoid; }
  a { color: #1e40af; }
  .stage-chart { height: 250px; }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  .loading-spinner { animation: none; }
}
</style>
</head>
<body>

<div class="header">
  <h1>Pipeline Optimizer</h1>
  <p>AI-powered scheduling optimization and bottleneck detection</p>
  <div class="header-stats">
    <div class="header-stat">
      <div class="header-stat-value" id="total-projects">--</div>
      <div class="header-stat-label">Total Projects</div>
    </div>
    <div class="header-stat">
      <div class="header-stat-value" id="schedulable">--</div>
      <div class="header-stat-label">Ready to Schedule</div>
    </div>
    <div class="header-stat">
      <div class="header-stat-value" id="bottleneck-count">--</div>
      <div class="header-stat-label">Bottlenecks</div>
    </div>
    <div class="header-stat">
      <div class="header-stat-value" id="pe-rate">--</div>
      <div class="header-stat-label">PE Compliance</div>
    </div>
  </div>
</div>

<div class="container">
  <div class="grid-2" style="margin-bottom: 1.5rem;">
    <!-- Bottlenecks -->
    <div class="card">
      <div class="card-title">Bottleneck Detection</div>
      <div id="bottlenecks"></div>
    </div>

    <!-- Priority Queue -->
    <div class="card">
      <div class="card-title">Optimized Priority Queue</div>
      <div id="priority-queue"></div>
    </div>
  </div>

  <!-- Efficiency Metrics -->
  <div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-title">Location Efficiency Scores</div>
    <div id="efficiency"></div>
  </div>

  <!-- Stage Analysis Chart -->
  <div class="grid-2">
    <div class="card">
      <div class="card-title">Average Days by Stage</div>
      <div class="stage-chart">
        <canvas id="stageChart"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Schedule Distribution</div>
      <div class="stage-chart">
        <canvas id="scheduleChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Full Priority Table -->
  <div class="section-title">Complete Optimized Schedule Queue</div>
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Project</th>
          <th>Location</th>
          <th>Stage</th>
          <th>Install Timeline</th>
          <th>Value</th>
          <th>Score</th>
          <th>Rec. Date</th>
        </tr>
      </thead>
      <tbody id="queue-table"></tbody>
    </table>
  </div>
</div>

<script id="opt-data" type="application/json">
{
  "generated_at": "2026-01-17T03:45:50.686836",
  "total_projects": 478,
  "schedulable_projects": 26,
  "optimized_queue": [
    {
      "id": 28860087969,
      "name": "PROJ-7370 | Pelisek, Katie | 1620 Geneseo Rd, Paso Robles, CA 93446",
      "location": "San Luis Obispo",
      "stage": "Ready To Build",
      "score": 842.6,
      "is_pe": true,
      "amount": 32950.0,
      "days_to_install": -333,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/28860087969?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 28462208159,
      "name": "PROJ-7292 | Smith, Richard | 34979 Sky Ranch Road, Carmel Valley, CA 93924",
      "location": "San Luis Obispo",
      "stage": "Ready To Build",
      "score": 616.2,
      "is_pe": true,
      "amount": 21070.0,
      "days_to_install": -221,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/28462208159?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 19495669155,
      "name": "PROJ-7945 | Sahagun, Damen | 4435 Holly St, Guadalupe, CA 93434",
      "location": "San Luis Obispo",
      "stage": "Ready To Build",
      "score": 525.7,
      "is_pe": false,
      "amount": 28399.55,
      "days_to_install": -200,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/19495669155?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 22337108294,
      "name": "PROJ-8006 | Yan Zhang, Hai | 7 Benchmark Dr, Boulder, CO 80303",
      "location": "Westminster",
      "stage": "Ready To Build",
      "score": 498.4,
      "is_pe": true,
      "amount": 32006.72,
      "days_to_install": -161,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/22337108294?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 38866623353,
      "name": "PROJ-8091 | Rakoski, Noah | 20120 Wells Dr, Woodland Hills , CA 91364",
      "location": "Camarillo",
      "stage": "Ready To Build",
      "score": 480.7,
      "is_pe": true,
      "amount": 63744.75,
      "days_to_install": -149,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/38866623353?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 36741931101,
      "name": "PROJ-7981 | Aguilar, JaKe | 351 Panay st , Morro Bay, CA 93442",
      "location": "San Luis Obispo",
      "stage": "Ready To Build",
      "score": 476.4,
      "is_pe": true,
      "amount": 12043.47,
      "days_to_install": -152,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/36741931101?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 20307498596,
      "name": "PROJ-8182 | Hancz, Brian | 213 Deer Trail Cir, Boulder, CO 80302",
      "location": "Westminster",
      "stage": "Ready To Build",
      "score": 381.5,
      "is_pe": false,
      "amount": 37387.86,
      "days_to_install": -127,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/20307498596?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 39049084790,
      "name": "PROJ-8128 | Martin, Annette | 2940 18th St, Boulder, CO 80304",
      "location": "Westminster",
      "stage": "Ready To Build",
      "score": 363.9,
      "is_pe": false,
      "amount": 49459.9,
      "days_to_install": -117,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/39049084790?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 42755755408,
      "name": "PROJ-8609 | Case, Jared | 367 Nueve Ct, Camarillo, CA 93012",
      "location": "Camarillo",
      "stage": "Ready To Build",
      "score": 306.8,
      "is_pe": true,
      "amount": 29944.34,
      "days_to_install": -68,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/42755755408?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 41434163825,
      "name": "PROJ-8596 | Eckert, Dieter | 3680 Oakdale Road , Paso Robles, CA 93446",
      "location": "San Luis Obispo",
      "stage": "Ready To Build",
      "score": 306.7,
      "is_pe": false,
      "amount": 36274.0,
      "days_to_install": -92,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/41434163825?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 41511499107,
      "name": "PROJ-8466 | Patel, Miraj | 3187 Calle De Debesa, Camarillo, CA 93010",
      "location": "Camarillo",
      "stage": "Ready To Build",
      "score": 298.1,
      "is_pe": false,
      "amount": 5600.0,
      "days_to_install": -89,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/41511499107?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 43817717324,
      "name": "PROJ-8683 | Richards, Amy M  | 645 Skyline Rd, Ventura, CA 93003",
      "location": "Camarillo",
      "stage": "Ready To Build",
      "score": 270.2,
      "is_pe": true,
      "amount": 55767.89,
      "days_to_install": -49,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/43817717324?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 43946261506,
      "name": "PROJ-8697 | Castillo, David | 1878 Hobart Drive, Camarillo, CA 93010",
      "location": "Camarillo",
      "stage": "Ready To Build",
      "score": 258.2,
      "is_pe": true,
      "amount": 18203.94,
      "days_to_install": -47,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/43946261506?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 28809813653,
      "name": "PROJ-8762 | Ellis, David | 11295 Los Osos Valley Rd #27, San Luis Obispo, CA 93405",
      "location": "San Luis Obispo",
      "stage": "Ready To Build",
      "score": 248.8,
      "is_pe": true,
      "amount": 25971.4,
      "days_to_install": -44,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/28809813653?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 42725891186,
      "name": "PROJ-8535 | Amery, Heather | 1100 Milwaukee St, Denver, CO 80206-3340",
      "location": "Centennial",
      "stage": "Ready To Build",
      "score": 242.7,
      "is_pe": false,
      "amount": 18291.0,
      "days_to_install": -61,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/42725891186?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 42265220259,
      "name": "PROJ-8540 | Norholm, Poul | 301 Fair Oaks Ave, Arroyo Grande, CA 93420",
      "location": "San Luis Obispo",
      "stage": "Ready To Build",
      "score": 215.4,
      "is_pe": true,
      "amount": 42771.6,
      "days_to_install": -20,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/42265220259?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 45369375558,
      "name": "PROJ-8730 | Diep, Jason | 2277 El Nido Ct, Camarillo, CA 93010",
      "location": "Camarillo",
      "stage": "Ready To Build",
      "score": 214.6,
      "is_pe": true,
      "amount": 42966.0,
      "days_to_install": -34,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/45369375558?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 42969550992,
      "name": "PROJ-8632 | Johnston, Jeanette | Santa Fe 2nd NW of Ocean Ave, Carmel, CA 93921",
      "location": "San Luis Obispo",
      "stage": "Ready To Build",
      "score": 204.2,
      "is_pe": true,
      "amount": 24219.0,
      "days_to_install": -28,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/42969550992?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 45934137926,
      "name": "PROJ-8749 | Casselman, David | 27002 Malibu Cove Colony Dr, Malibu, CA 90265",
      "location": "Camarillo",
      "stage": "Ready To Build",
      "score": 196.5,
      "is_pe": true,
      "amount": 29431.08,
      "days_to_install": -27,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/45934137926?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 45151434504,
      "name": "PROJ-8723 | Baker, Bradley | 12460 Woodruff Dr, Colorado Springs, CO 80921",
      "location": "Colorado Springs",
      "stage": "Ready To Build",
      "score": 190.9,
      "is_pe": true,
      "amount": 33489.9,
      "days_to_install": -13,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/45151434504?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 48475133869,
      "name": "PROJ-8810 | Rahane, Annasaheb | 194 Rose St, Fillmore, CA 93015",
      "location": "Camarillo",
      "stage": "Ready To Build",
      "score": 137.0,
      "is_pe": true,
      "amount": 18203.94,
      "days_to_install": -1,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/48475133869?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 49728894116,
      "name": "PROJ-8846 | Lau, Michael | 6325 Mira Cielo, San Luis Obispo, CA, USA, San Luis Obispo, CA 93401",
      "location": "San Luis Obispo",
      "stage": "Ready To Build",
      "score": 114.8,
      "is_pe": false,
      "amount": 23800.0,
      "days_to_install": -5,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/49728894116?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 49134683809,
      "name": "PROJ-8832 | Harris, Robert | 669 Larchmont St , Simi Valley , CA 93065",
      "location": "Camarillo",
      "stage": "Ready To Build",
      "score": 110.2,
      "is_pe": true,
      "amount": 13198.8,
      "days_to_install": 3,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/49134683809?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 46825526853,
      "name": "PROJ-8771 | Rassokhin, Vasily | 8470 W 74th Dr, Arvada, CO 80005",
      "location": "Westminster",
      "stage": "Ready To Build",
      "score": 89.9,
      "is_pe": false,
      "amount": 34258.0,
      "days_to_install": 2,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/46825526853?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 54101287304,
      "name": "PROJ-9004 | Frantz, John | , ,  ",
      "location": "Unknown",
      "stage": "Ready To Build",
      "score": 8.3,
      "is_pe": false,
      "amount": 41702.08,
      "days_to_install": 73,
      "recommended_date": null,
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/54101287304?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    },
    {
      "id": 50909782639,
      "name": "PROJ-8943 | Duross, Tom | 1823 Mira Vista , Santa Barbara, CA 93103",
      "location": "Camarillo",
      "stage": "Ready To Build",
      "score": 0.6,
      "is_pe": false,
      "amount": 2750.0,
      "days_to_install": 57,
      "recommended_date": "2026-01-18",
      "url": "https://app.hubspot.com/contacts/21710069/record/0-3/50909782639?utm_source=app_16228553_mcp&utm_medium=ai_agent&utm_campaign=search"
    }
  ],
  "bottlenecks": [
    {
      "type": "stage_accumulation",
      "severity": "high",
      "title": "Inspection Backlog",
      "description": "121 projects stuck in Inspection stage",
      "impact": "$4766k pipeline value affected",
      "avg_days_in_stage": 250.7,
      "recommendation": "Review Inspection process - consider adding resources or expediting"
    },
    {
      "type": "pe_milestone_risk",
      "severity": "high",
      "title": "Participate Energy Milestone Risk",
      "description": "38 PE projects approaching milestone deadlines",
      "impact": "$1517k in PE revenue at risk",
      "recommendation": "Prioritize PE projects in scheduling queue"
    }
  ],
  "efficiency_metrics": {
    "avg_days_by_stage": {
      "Ready To Build": 147.3,
      "Site Survey": 33.8,
      "Inspection": 250.7,
      "Design & Engineering": 52.7,
      "Permitting & Interconnection": 92.8,
      "Construction": 238.2,
      "Permission To Operate": 304.0,
      "RTB - Blocked": 196.8
    },
    "weekly_throughput_estimate": 0.0,
    "pe_compliance_rate": 80.4,
    "location_efficiency": {
      "Westminster": {
        "avg_cycle_days": 171.3,
        "overdue_pct": 75.8,
        "score": -61.5
      },
      "Centennial": {
        "avg_cycle_days": 144.1,
        "overdue_pct": 63.2,
        "score": -35.3
      },
      "Colorado Springs": {
        "avg_cycle_days": 137.1,
        "overdue_pct": 58.8,
        "score": -27.4
      },
      "San Luis Obispo": {
        "avg_cycle_days": 340.7,
        "overdue_pct": 95.0,
        "score": -165.4
      },
      "Camarillo": {
        "avg_cycle_days": 145.9,
        "overdue_pct": 79.7,
        "score": -52.6
      }
    }
  },
  "schedule_by_location": {
    "San Luis Obispo": 9,
    "Westminster": 4,
    "Camarillo": 10,
    "Centennial": 1,
    "Colorado Springs": 1
  }
}</script>
<script>
// Safe JSON parsing with error handling
let data;
try {
  data = JSON.parse(document.getElementById('opt-data').textContent);
} catch (e) {
  console.error('Failed to parse optimization data:', e);
  document.body.innerHTML = '<div class="error-message">Failed to load dashboard data. Please refresh the page or contact support.</div>';
  throw e;
}

// Update header stats
document.getElementById('total-projects').textContent = data.total_projects;
document.getElementById('schedulable').textContent = data.schedulable_projects;
document.getElementById('bottleneck-count').textContent = data.bottlenecks.length;
document.getElementById('pe-rate').textContent = data.efficiency_metrics.pe_compliance_rate + '%';

// Render bottlenecks
const bottlenecksEl = document.getElementById('bottlenecks');
bottlenecksEl.innerHTML = data.bottlenecks.map(b => `
  <div class="bottleneck ${b.severity}">
    <div class="bottleneck-title">
      <span class="badge badge-${b.severity}">${b.severity.toUpperCase()}</span>
      ${b.title}
    </div>
    <div class="bottleneck-desc">${b.description}</div>
    <div class="bottleneck-impact">${b.impact}</div>
    <div class="bottleneck-rec"><strong>Recommendation:</strong> ${b.recommendation}</div>
  </div>
`).join('');

// Helper: Format days display
function formatDaysToInstall(days) {
  if (days === null || days === undefined) return 'N/A';
  if (days === 0) return 'due today';
  if (days < 0) return `${Math.abs(days)}d overdue`;
  return `in ${days}d`;
}

// Helper: Get next business day (skips weekends)
function getNextBusinessDay(date) {
  const d = new Date(date);
  const day = d.getDay();
  if (day === 0) d.setDate(d.getDate() + 1); // Sunday -> Monday
  if (day === 6) d.setDate(d.getDate() + 2); // Saturday -> Monday
  return d;
}

// Helper: Format recommended date (business days only)
function formatRecommendedDate(dateStr) {
  if (!dateStr) return '-';
  const date = getNextBusinessDay(new Date(dateStr));
  return date.toISOString().split('T')[0];
}

// Render priority queue (top 10)
const queueEl = document.getElementById('priority-queue');
queueEl.innerHTML = data.optimized_queue.slice(0, 10).map((p, i) => `
  <div class="priority-item">
    <div class="priority-rank">${i + 1}</div>
    <div class="priority-info">
      <div class="priority-name">
        <a href="${p.url}" target="_blank">${p.name.split('|')[0].trim()}</a>
        ${p.is_pe ? '<span class="pe-badge">PE</span>' : ''}
      </div>
      <div class="priority-meta">${p.location} | ${formatDaysToInstall(p.days_to_install)} | $${(p.amount/1000).toFixed(0)}k</div>
    </div>
    <div class="priority-score">
      <div class="priority-score-value">${p.score.toFixed(0)}</div>
      <div class="priority-score-label">score</div>
    </div>
  </div>
`).join('');

// Render efficiency bars
const effEl = document.getElementById('efficiency');
const locations = Object.entries(data.efficiency_metrics.location_efficiency)
  .sort((a, b) => b[1].score - a[1].score);

effEl.innerHTML = locations.map(([loc, stats]) => {
  // Normalize score for display (all negative, so adjust)
  const normalizedScore = Math.max(0, 100 + stats.score);
  const color = normalizedScore > 60 ? '#10b981' : normalizedScore > 30 ? '#f59e0b' : '#ef4444';
  return `
    <div class="efficiency-bar">
      <div class="efficiency-loc">${loc}</div>
      <div class="efficiency-progress">
        <div class="efficiency-fill" style="width: ${normalizedScore}%; background: ${color};"></div>
      </div>
      <div class="efficiency-score" style="color: ${color};">${stats.score.toFixed(0)}</div>
    </div>
  `;
}).join('');

// Render full table
const tableEl = document.getElementById('queue-table');
tableEl.innerHTML = data.optimized_queue.map((p, i) => {
  const daysClass = p.days_to_install < 0 ? 'days-overdue' : p.days_to_install <= 7 ? 'days-urgent' : 'days-ok';
  return `
    <tr>
      <td>${i + 1}</td>
      <td>
        <a href="${p.url}" target="_blank">${p.name.split('|')[0].trim()}</a>
        ${p.is_pe ? '<span class="pe-badge">PE</span>' : ''}
      </td>
      <td>${p.location}</td>
      <td>${p.stage}</td>
      <td><span class="days-badge ${daysClass}">${formatDaysToInstall(p.days_to_install)}</span></td>
      <td>$${(p.amount/1000).toFixed(0)}k</td>
      <td><strong>${p.score.toFixed(0)}</strong></td>
      <td>${formatRecommendedDate(p.recommended_date)}</td>
    </tr>
  `;
}).join('');

// Stage Chart
const stageData = data.efficiency_metrics.avg_days_by_stage;
const stageLabels = Object.keys(stageData);
const stageValues = Object.values(stageData);

new Chart(document.getElementById('stageChart'), {
  type: 'bar',
  data: {
    labels: stageLabels,
    datasets: [{
      label: 'Avg Days in Stage',
      data: stageValues,
      backgroundColor: stageValues.map(v => v > 200 ? '#ef4444' : v > 100 ? '#f59e0b' : '#10b981'),
      borderRadius: 4
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    indexAxis: 'y',
    plugins: { legend: { display: false } },
    scales: {
      x: {
        grid: { color: '#334155' },
        ticks: { color: '#94a3b8' }
      },
      y: {
        grid: { display: false },
        ticks: { color: '#f1f5f9', font: { size: 10 } }
      }
    }
  }
});

// Schedule Distribution Chart
const schedData = data.schedule_by_location;
new Chart(document.getElementById('scheduleChart'), {
  type: 'doughnut',
  data: {
    labels: Object.keys(schedData),
    datasets: [{
      data: Object.values(schedData),
      backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899']
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'right',
        labels: { color: '#f1f5f9', padding: 15 }
      }
    }
  }
});

// Accessibility: Make table rows keyboard navigable
document.querySelectorAll('tr').forEach(row => {
  row.setAttribute('tabindex', '0');
  row.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const link = row.querySelector('a');
      if (link) link.click();
    }
  });
});

// Add timestamp
const timestamp = data.generated_at ? new Date(data.generated_at) : new Date();
console.log('Dashboard data generated at:', timestamp.toLocaleString());
</script>
</body>
</html>
